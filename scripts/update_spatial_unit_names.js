import mongoose from 'mongoose';
import dotenv from 'dotenv';
import SpatialUnit from '../models/SpatialUnit.js';
import { connectDB } from '../config/database.js';

dotenv.config();

/**
 * 행정동 코드를 실제 지역명으로 변환
 * 
 * 서울시 행정동 코드 매핑 (일부 예시)
 * 실제로는 전체 매핑 테이블이 필요하지만, 여기서는 주요 지역만 포함
 */
const DONG_CODE_MAP = {
  // 종로구 (11110)
  '11110500': '청운효자동',
  '11110501': '신교동',
  '11110502': '궁정동',
  '11110503': '사직동',
  '11110504': '세종로',
  '11110505': '자하문로',
  '11110506': '당주동',
  '11110507': '내수동',
  '11110508': '삼청동',
  '11110509': '부암동',
  '11110510': '백석동',
  '11110511': '지봉동',
  '11110512': '평창동',
  '11110513': '옥인동',
  '11110514': '누하동',
  '11110515': '필운동',
  '11110516': '무악동',
  '11110517': '인사동',
  '11110518': '도렴동',
  '11110519': '교남동',
  '11110520': '가회동',
  '11110521': '종로1.2.3.4가동',
  '11110522': '계동',
  '11110523': '종로5.6가동',
  '11110524': '원서동',
  '11110525': '훈정동',
  '11110526': '묘동',
  '11110527': '이화동',
  '11110528': '혜화동',
  '11110530': '창신동',
  '11110531': '숭인동',
  '11110534': '청진동',
  '11110535': '서린동',
  '11110538': '수송동',
  '11110539': '중학동',
  '11110540': '종로동',
  '11110542': '효제동',
  '11110543': '연지동',
  '11110544': '충신동',
  
  // 중구 (11140)
  '11140520': '소공동',
  '11140540': '회현동',
  '11140550': '명동',
  '11140570': '필동',
  '11140580': '장충동',
  '11140590': '광희동',
  '11140600': '을지로동',
  '11140615': '신당동',
  '11140620': '다산동',
  '11140635': '약수동',
  '11140645': '청구동',
  '11140650': '신당5동',
  '11140670': '중림동',
  
  // 용산구 (11170)
  '11170510': '남영동',
  '11170520': '원효로1동',
  '11170530': '원효로2동',
  '11170540': '효창동',
  '11170550': '용산2가동',
  '11170560': '한강로동',
  '11170570': '이촌1동',
  '11170580': '이촌2동',
  '11170590': '이태원1동',
  '11170600': '이태원2동',
  '11170610': '한남동',
  '11170620': '서빙고동',
  '11170630': '보광동',
  
  // 성동구 (11200)
  '11200520': '왕십리2동',
  '11200530': '왕십리도선동',
  '11200540': '마장동',
  '11200550': '사근동',
  '11200560': '행당1동',
  '11200570': '행당2동',
  '11200580': '응봉동',
  '11200590': '금호1가동',
  '11200605': '금호2.3가동',
  '11200610': '금호4가동',
  '11200620': '옥수동',
  '11200630': '성수1가1동',
  '11200640': '성수1가2동',
  '11200650': '성수2가1동',
  '11200660': '성수2가3동',
  '11200670': '송정동',
  '11200680': '용답동',
  
  // 광진구 (11215)
  '11215510': '화양동',
  '11215520': '군자동',
  '11215530': '능동',
  '11215540': '광장동',
  '11215550': '자양1동',
  '11215560': '자양2동',
  '11215570': '자양3동',
  '11215580': '자양4동',
  '11215590': '구의1동',
  '11215600': '구의2동',
  '11215610': '구의3동',
  '11215620': '건국대동',
  
  // 동대문구 (11230)
  '11230520': '용신동',
  '11230540': '제기동',
  '11230550': '전농1동',
  '11230560': '전농2동',
  '11230570': '답십리1동',
  '11230580': '답십리2동',
  '11230590': '장안1동',
  '11230600': '장안2동',
  '11230610': '청량리동',
  '11230620': '회기동',
  '11230630': '휘경1동',
  '11230640': '휘경2동',
  '11230650': '이문1동',
  '11230660': '이문2동',
  
  // 중랑구 (11260)
  '11260520': '면목2동',
  '11260540': '면목4동',
  '11260550': '면목5동',
  '11260565': '면목본동',
  '11260570': '면목7동',
  '11260580': '면목3.8동',
  '11260600': '상봉1동',
  '11260610': '상봉2동',
  '11260620': '중화1동',
  '11260630': '중화2동',
  '11260640': '묵1동',
  '11260650': '묵2동',
  '11260660': '망우본동',
  '11260670': '망우3동',
  '11260680': '신내1동',
  '11260690': '신내2동',
  
  // 성북구 (11290)
  '11290525': '성북동',
  '11290555': '삼선동',
  '11290565': '동선동',
  '11290575': '돈암1동',
  '11290585': '돈암2동',
  '11290600': '안암동',
  '11290610': '보문동',
  '11290620': '정릉1동',
  '11290630': '정릉2동',
  '11290640': '정릉3동',
  '11290650': '정릉4동',
  '11290660': '길음1동',
  '11290685': '길음2동',
  '11290705': '종암동',
  '11290715': '하월곡동',
  '11290725': '상월곡동',
  '11290730': '장위1동',
  '11290740': '장위2동',
  '11290750': '장위3동',
  '11290760': '석관동',
  
  // 강북구 (11305)
  '11305510': '삼양동',
  '11305520': '미아동',
  '11305530': '송중동',
  '11305540': '송천동',
  '11305550': '삼각산동',
  '11305560': '번1동',
  '11305570': '번2동',
  '11305580': '번3동',
  '11305590': '수유1동',
  '11305600': '수유2동',
  '11305610': '수유3동',
  '11305620': '우이동',
  '11305630': '인수동',
  
  // 도봉구 (11320)
  '11320511': '쌍문1동',
  '11320512': '쌍문2동',
  '11320513': '쌍문3동',
  '11320514': '쌍문4동',
  '11320521': '방학1동',
  '11320522': '방학2동',
  '11320523': '방학3동',
  '11320531': '창1동',
  '11320532': '창2동',
  '11320533': '창3동',
  '11320534': '창4동',
  '11320535': '창5동',
  '11320545': '도봉1동',
  '11320546': '도봉2동',
  
  // 노원구 (11350)
  '11350560': '월계1동',
  '11350570': '월계2동',
  '11350580': '월계3동',
  '11350595': '공릉1동',
  '11350600': '공릉2동',
  '11350611': '하계1동',
  '11350612': '하계2동',
  '11350620': '중계본동',
  '11350621': '중계1동',
  '11350624': '중계4동',
  '11350625': '중계2.3동',
  '11350630': '상계1동',
  '11350640': '상계2동',
  '11350650': '상계3.4동',
  '11350665': '상계5동',
  '11350670': '상계6.7동',
  '11350680': '상계8동',
  '11350690': '상계9동',
  '11350700': '상계10동',
  
  // 은평구 (11380)
  '11380510': '녹번동',
  '11380520': '불광1동',
  '11380530': '불광2동',
  '11380551': '갈현1동',
  '11380552': '갈현2동',
  '11380560': '구산동',
  '11380570': '대조동',
  '11380580': '응암1동',
  '11380590': '응암2동',
  '11380600': '응암3동',
  '11380625': '신사1동',
  '11380630': '신사2동',
  '11380640': '증산동',
  '11380650': '수색동',
  
  // 서대문구 (11410)
  '11410520': '천연동',
  '11410540': '충현동',
  '11410550': '신촌동',
  '11410560': '연희동',
  '11410620': '홍제1동',
  '11410640': '홍제2동',
  '11410655': '홍제3동',
  '11410660': '홍은1동',
  '11410680': '홍은2동',
  '11410690': '남가좌1동',
  '11410700': '남가좌2동',
  '11410710': '북가좌1동',
  '11410720': '북가좌2동',
  
  // 마포구 (11440)
  '11440555': '공덕동',
  '11440565': '아현동',
  '11440585': '도화동',
  '11440590': '용강동',
  '11440600': '대흥동',
  '11440610': '염리동',
  '11440630': '신수동',
  '11440650': '서강동',
  '11440660': '서교동',
  '11440680': '합정동',
  '11440690': '망원1동',
  '11440700': '망원2동',
  '11440710': '상암동',
  '11440720': '성산1동',
  '11440730': '성산2동',
  '11440740': '상암동',
  '11440750': '상암동',
  
  // 양천구 (11470)
  '11470510': '목1동',
  '11470520': '목2동',
  '11470530': '목3동',
  '11470540': '목4동',
  '11470550': '목5동',
  '11470560': '신월1동',
  '11470570': '신월2동',
  '11470580': '신월3동',
  '11470590': '신월4동',
  '11470600': '신월5동',
  '11470610': '신월6동',
  '11470611': '신월7동',
  '11470620': '신정1동',
  '11470630': '신정2동',
  '11470640': '신정3동',
  '11470650': '신정4동',
  '11470660': '신정6동',
  '11470670': '신정7동',
  
  // 강서구 (11500)
  '11500510': '염창동',
  '11500520': '등촌1동',
  '11500530': '등촌2동',
  '11500535': '등촌3동',
  '11500540': '화곡1동',
  '11500550': '화곡2동',
  '11500560': '화곡3동',
  '11500570': '화곡4동',
  '11500590': '화곡본동',
  '11500591': '화곡6동',
  '11500603': '화곡8동',
  '11500610': '가양1동',
  '11500620': '가양2동',
  '11500630': '가양3동',
  '11500640': '발산1동',
  '11500650': '우장산동',
  '11500660': '공항동',
  '11500670': '방화1동',
  '11500680': '방화2동',
  '11500681': '방화3동',
  
  // 구로구 (11530)
  '11530510': '신도림동',
  '11530520': '구로1동',
  '11530530': '구로2동',
  '11530540': '구로3동',
  '11530550': '구로4동',
  '11530560': '구로5동',
  '11530595': '가리봉동',
  '11530720': '고척1동',
  '11530730': '고척2동',
  '11530740': '개봉1동',
  '11530750': '개봉2동',
  '11530760': '개봉3동',
  '11530770': '오류1동',
  '11530780': '오류2동',
  '11530790': '수궁동',
  '11530800': '항동',
  
  // 금천구 (11545)
  '11545510': '가산동',
  '11545610': '독산1동',
  '11545620': '독산2동',
  '11545630': '독산3동',
  '11545640': '독산4동',
  '11545670': '시흥1동',
  '11545680': '시흥2동',
  '11545690': '시흥3동',
  '11545700': '시흥4동',
  '11545710': '시흥5동',
  
  // 영등포구 (11560)
  '11560515': '영등포본동',
  '11560535': '영등포동',
  '11560540': '여의도동',
  '11560550': '당산1동',
  '11560560': '당산2동',
  '11560585': '도림동',
  '11560605': '문래동',
  '11560610': '양평1동',
  '11560620': '양평2동',
  '11560630': '신길1동',
  '11560640': '신길3동',
  '11560650': '신길4동',
  '11560660': '신길5동',
  '11560670': '신길6동',
  '11560680': '신길7동',
  '11560690': '대림1동',
  '11560700': '대림2동',
  '11560710': '대림3동',
  
  // 동작구 (11590)
  '11590510': '노량진1동',
  '11590520': '노량진2동',
  '11590530': '상도1동',
  '11590540': '상도2동',
  '11590550': '상도3동',
  '11590560': '상도4동',
  '11590610': '흑석동',
  '11590620': '사당1동',
  '11590630': '사당2동',
  '11590640': '사당3동',
  '11590650': '사당4동',
  '11590651': '사당5동',
  '11590660': '대방동',
  '11590670': '신대방1동',
  '11590680': '신대방2동',
  
  // 관악구 (11620)
  '11620525': '보라동',
  '11620545': '청림동',
  '11620565': '성현동',
  '11620575': '행운동',
  '11620585': '낙성대동',
  '11620595': '청룡동',
  '11620605': '은천동',
  '11620615': '중앙동',
  '11620625': '인헌동',
  '11620630': '남현동',
  '11620645': '서원동',
  '11620655': '신원동',
  '11620665': '서림동',
  '11620685': '삼성동',
  '11620695': '미성동',
  '11620705': '난곡동',
  '11620715': '난향동',
  '11620725': '조원동',
  '11620735': '대학동',
  '11620745': '삼성동',
  
  // 서초구 (11650)
  '11650510': '방배1동',
  '11650520': '방배2동',
  '11650530': '방배3동',
  '11650540': '방배4동',
  '11650551': '양재1동',
  '11650552': '양재2동',
  '11650560': '내곡동',
  '11650580': '염곡동',
  '11650590': '신원동',
  '11650600': '원지동',
  '11650615': '잠원동',
  '11650625': '반포본동',
  '11650640': '반포1동',
  '11650650': '반포2동',
  '11650660': '반포3동',
  '11650670': '반포4동',
  '11650680': '잠원동',
  '11650690': '반포본동',
  
  // 강남구 (11680)
  '11680510': '논현1동',
  '11680520': '논현2동',
  '11680525': '논현본동',
  '11680530': '압구정동',
  '11680540': '청담동',
  '11680550': '삼성1동',
  '11680560': '삼성2동',
  '11680570': '대치1동',
  '11680580': '대치2동',
  '11680590': '대치4동',
  '11680600': '역삼1동',
  '11680610': '역삼2동',
  '11680621': '도곡1동',
  '11680630': '도곡2동',
  '11680640': '개포1동',
  '11680650': '개포2동',
  '11680660': '개포4동',
  '11680670': '세곡동',
  '11680680': '일원본동',
  '11680690': '일원1동',
  '11680700': '일원2동',
  '11680710': '수서동',
  
  // 송파구 (11710)
  '11710510': '잠실본동',
  '11710520': '잠실2동',
  '11710530': '잠실3동',
  '11710540': '잠실4동',
  '11710550': '잠실6동',
  '11710560': '잠실7동',
  '11710610': '신천동',
  '11710620': '풍납1동',
  '11710630': '풍납2동',
  '11710640': '거여1동',
  '11710650': '거여2동',
  '11710660': '마천1동',
  '11710670': '마천2동',
  '11710680': '방이1동',
  '11710690': '방이2동',
  '11710700': '오륜동',
  '11710710': '오금동',
  '11710720': '송파1동',
  '11710730': '송파2동',
  '11710740': '석촌동',
  '11710750': '삼전동',
  '11710760': '가락본동',
  '11710770': '가락1동',
  '11710780': '가락2동',
  '11710790': '문정1동',
  '11710800': '문정2동',
  '11710810': '장지동',
  '11710820': '위례동',
  '11710830': '잠실본동',
  
  // 강동구 (11740)
  '11740510': '명일1동',
  '11740520': '명일2동',
  '11740530': '고덕1동',
  '11740540': '고덕2동',
  '11740550': '암사1동',
  '11740560': '암사2동',
  '11740570': '암사3동',
  '11740580': '천호1동',
  '11740590': '천호2동',
  '11740600': '천호3동',
  '11740610': '성내1동',
  '11740620': '성내2동',
  '11740630': '성내3동',
  '11740640': '길동',
  '11740650': '둔촌1동',
  '11740660': '둔촌2동',
  '11740670': '상일동',
  '11740680': '상일1동',
  '11740690': '상일2동',
  '11740700': '강일동',
};

/**
 * 행정동 코드로 지역명 찾기
 * 매핑 정보가 없으면 unit_id를 기반으로 추정
 */
function getDongName(unitId) {
  // 먼저 매핑 테이블에서 찾기
  if (DONG_CODE_MAP[unitId]) {
    return DONG_CODE_MAP[unitId];
  }
  
  // 매핑 정보가 없으면 unit_id를 기반으로 추정
  // 예: 11110501 → "지역2" 대신 "종로구 행정동" 같은 형식으로 표시
  // 하지만 일단은 null 반환하여 기존 이름 유지
  return null;
}

/**
 * Spatial Unit 이름 업데이트
 */
async function updateSpatialUnitNames() {
  try {
    console.log('🚀 Updating spatial unit names...\n');
    
    await connectDB();
    
    const units = await SpatialUnit.find({});
    console.log(`📊 Found ${units.length} spatial units\n`);
    
    let updatedCount = 0;
    let notFoundCount = 0;
    
    for (const unit of units) {
      const dongName = getDongName(unit._id);
      
      if (dongName) {
        // 기존 이름이 "지역X" 형식이거나 더미 이름인 경우에만 업데이트
        if (unit.name.startsWith('지역') || unit.name.startsWith('테스트')) {
          await SpatialUnit.findByIdAndUpdate(unit._id, { name: dongName });
          console.log(`  ✅ ${unit._id}: "${unit.name}" → "${dongName}"`);
          updatedCount++;
        } else {
          console.log(`  ⏭️  ${unit._id}: "${unit.name}" (이미 업데이트됨)`);
        }
      } else {
        console.log(`  ⚠️  ${unit._id}: 매핑 정보 없음 (현재 이름: "${unit.name}")`);
        notFoundCount++;
      }
    }
    
    console.log(`\n✅ 업데이트 완료!`);
    console.log(`   업데이트된 지역: ${updatedCount}개`);
    console.log(`   매핑 정보 없음: ${notFoundCount}개\n`);
    
    await mongoose.connection.close();
    process.exit(0);
  } catch (error) {
    console.error('❌ Error:', error);
    await mongoose.connection.close();
    process.exit(1);
  }
}

updateSpatialUnitNames();

